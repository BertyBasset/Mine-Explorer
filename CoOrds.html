<html>
    <head>
        <title>OSGB364 Co-Ordinate Converter</title>
        <link rel="stylesheet" href="main.css" />
        <style>

            /* Page Specific Styling */
            .container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                max-width: 700px;
                margin: auto;
            }

            .options {
                max-width: 270px;
                margin: auto;
                align-items: left;
                text-align: left;
            }

            .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            }            
            textarea {
                color: #dedede;
                background-color: #282838;
                width: 250px;
                height: 350px;
                margin: 10px;
                resize: none;
                border-radius: 3px;
                border-color: #373737;

            }
            fieldset {

                justify-content: space-between;
                align-items: left;
                max-width: 400px;
                margin: auto;
                border-color: gray;
            }



        </style>    
        <script src="./javascript/os.js"></script>
        <script>


            
            function setPrecisionVisibility() {
               if(document.getElementById('optGridReference').checked) {
                    document.getElementById('lstPrecision').disabled = false;
                    document.getElementById('lstGridRef').placeholder = 'SS EEEE NNNN';
               } else {
                    document.getElementById('lstPrecision').disabled = true;
                    document.getElementById('lstGridRef').placeholder = 'EEEEEE NNNNNN';
               }
            }

            function convertToLonLat() {
                var isGridRef = false;

                if(document.getElementById('optGridReference').checked)          
                    isGridRef = true;

                var refs = document.getElementById("lstGridRef").value.split("\n");

                var out = "";
                osgb=new GT_OSGB();

                for(var r of refs) {
                    if(r.trim() == "") {
                        out += "\n";
                        continue;
                    }


                    if(isGridRef) {
                        if(osgb.parseGridRef(r)) {
                            wgs84=osgb.getWGS84();
                            out += wgs84.latitude.toFixed(6) + "," + wgs84.longitude.toFixed(6) + "\n";
                        } else {
                            out += "Invalid Grid Reference\n";
                        }

                    } else {
                        var eastnorth = r.split(" ");
                        if(eastnorth.length != 2) {
                            out += "Invalid Easting Northing\n";
                            continue;
                        }

                        var e = Number(eastnorth[0]);
                        var n = Number(eastnorth[1]);

                        if(isNaN(e)  || isNaN(n)) {
                            out += "Invalid Lat Lon\n";
                            continue;
                        }
                        
                        osgb.setGridCoordinates(e, n);
                        wgs84 = osgb.getWGS84();
                        out += wgs84.latitude.toFixed(6) + "," + wgs84.longitude.toFixed(6) + "\n";
                    }
                }    

                if(out.endsWith("\n"))
                    out = out.substring(0, out.length - 1);

                document.getElementById("lstLatLon").value = out;
            }   
            
            function convertToGrid() {
                var l = document.getElementById("lstLatLon").value.split("\n");
                
                var precision = 4;
                if(document.getElementById('lstPrecision').selectedIndex == 0)
                    precision = 4;
                else
                    precision = 3;

                var out = "";
                wgs84 = new GT_WGS84();

                for(var i of l) {
                    if(i.trim() == "") {
                        out += "\n";
                        continue;
                    }

                    var latlon = i.split(",");
                    if(latlon.length != 2) {
                        out += "Invalid Lat Lon\n";
                        continue;
                    }

                    var lat = Number(latlon[0]);
                    var lon = Number(latlon[1]);

                    if(isNaN(lat)  || isNaN(lon)) {
                        out += "Invalid Lat Lon\n";
                        continue;
                    }

                    if(lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                        out += "Invalid Lat Lon\n";
                        continue;
                    }

                    wgs84.setDegrees(lat, lon);
                    osgb=wgs84.getOSGB();
                    
                    if(document.getElementById('optGridReference').checked)
                        out += osgb.getGridRef(precision) + "\n";
                    else
                        out += osgb.eastings + " " + osgb.northings + "\n";

                    
                }
                
                if(out.endsWith("\n"))
                    out = out.substring(0, out.length - 1);

                document.getElementById("lstGridRef").value = out;
            }

        </script>
    </head>
    <body>
        <div class="banner"></div>        
        <menu class="MainMenu">
            <a href="https://buddlepit.co.uk">Forums</a>
            <a href="MineSearch.html">Mine Database</a>
            <a class="selected" href="CoOrds.html">Utilities</a>
            <a href="About.html">About</a>
            <a href="https://buddlepit.co.uk/community/index.php?login/">Login</a>
        </menu>
        <menu class="SubMenu">
            <a class="selected" href="CoOrds.html">GridRef Converter</a>

        </menu>


        <br /><br />
        <div class="container" style="position: relative; left:-5px;">
            <div>
                <label for="lstLatLon">Enter list of Lat Lons</label>
                <textarea id="lstLatLon" placeholder="Lat, Lon"></textarea>
            </div>
        
            <div class="button-container" style="position: relative; left:-2px;">
                <button id="btnConvert" onclick="convertToGrid()">Convert &#x2192;</button><br />
                <button id="btnConvert2" onclick="convertToLonLat()">&#x2190; Convert</button>
            </div>
        
            <div>
                <label for="lstGridRef">Grid References</label>
                <textarea id="lstGridRef" placeholder="SS EEEE NNNN"></textarea>
            </div>
        </div>
        <br />
        <fieldset>
            <legend>Grid Reference Options</legend>
            <div class="options">
                <input type="radio" name="gridOption" id="optGridReference" checked onchange="setPrecisionVisibility()" /><label for="optGridReference">Grid Reference (with sheet nos)</label><br />
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label for="lstPrecision">Precision</label>
                <select id="lstPrecision">
                    <option value="1">10m</option>
                    <option value="2">100m</option>
                </select>
                <br />
                <input type="radio" name="gridOption" id="optEastingNorthing"  onchange="setPrecisionVisibility()" /><label for="optEastingNorthing">Easting, Northing</label><br />
            </div>
        </fieldset> 

    </body>
</html>