<html>
    <head>
        <title>Mine Database</title>
        <link rel="stylesheet" href="main.css" />
        <script src="./javascript/os.js"></script>
    </head>
    <body>
        <div class="banner"></div>
        <menu class="MainMenu">
            <a href="https://buddlepit.co.uk">Forums</a>
            <a class="selected" href="MineSearch.html">Mine Database</a>
            <a href="CoOrds.html">Utilities</a>
            <a href="About.html">About</a>
            <a href="https://buddlepit.co.uk/community/index.php?login/">Login</a>
        </menu>
        <menu class="SubMenu">
            <a class="selected" href="MineSearch.html">Mine Search</a>
            <a href="MineMapView.html">Full Screen Map</a>
        </menu>

        <br />

        <div id="spinner-container">
            <div id="spinner">Loading...</div>
        </div>

        <div class="container">
            <div class="centered-div">
                <!-- Content of the centered div goes here -->
                <div class="centered-div">


                    <div class="search-form" style="text-align: center;">
                        Name starts with...&nbsp;&nbsp;&nbsp;  
                        <span class="letterSearch" onclick="letterSearch('A');">A</span> 
                        <span class="letterSearch" onclick="letterSearch('B');">B</span>  
                        <span class="letterSearch" onclick="letterSearch('C');">C</span> 
                        <span class="letterSearch" onclick="letterSearch('D');">D</span> 
                        <span class="letterSearch" onclick="letterSearch('E');">E</span> 
                        <span class="letterSearch" onclick="letterSearch('F');">F</span> 
                        <span class="letterSearch" onclick="letterSearch('G');">G</span> 
                        <span class="letterSearch" onclick="letterSearch('H');">H</span> 
                        <span class="letterSearch" onclick="letterSearch('I');">I</span> 
                        <span class="letterSearch" onclick="letterSearch('J');">J</span> 
                        <span class="letterSearch" onclick="letterSearch('K');">K</span> 
                        <span class="letterSearch" onclick="letterSearch('L');">L</span> 
                        <span class="letterSearch" onclick="letterSearch('M');">M</span> 
                        <span class="letterSearch" onclick="letterSearch('N');">N</span> 
                        <span class="letterSearch" onclick="letterSearch('O');">O</span> 
                        <span class="letterSearch" onclick="letterSearch('P');">P</span> 
                        <span class="letterSearch" onclick="letterSearch('Q');">Q</span> 
                        <span class="letterSearch" onclick="letterSearch('R');">R</span> 
                        <span class="letterSearch" onclick="letterSearch('S');">S</span> 
                        <span class="letterSearch" onclick="letterSearch('T');">T</span> 
                        <span class="letterSearch" onclick="letterSearch('U');">U</span> 
                        <span class="letterSearch" onclick="letterSearch('V');">V</span> 
                        <span class="letterSearch" onclick="letterSearch('W');">W</span> 
                        <span class="letterSearch" onclick="letterSearch('X');">X</span> 
                        <span class="letterSearch" onclick="letterSearch('Y');">Y</span> 
                        <span class="letterSearch" onclick="letterSearch('Z');">Z</span> 
                    </div>
                    <div class="horizontal-line"></div>    
                    <!-- Quick Search Form -->
                    <div class="search-form">
                        <label for="quick-search">Quick Search:</label>
                        <input type="text" id="quick-search" name="quick-search" placeholder="[enter search text" onkeydown="if(event.keyCode===13) quickSearch();" title="Searches Name(s), Location, History, WorkedStart, WorkedEnd, AccessDetails, Description and ConservationNotes" onfocus="this.select()" />
                        <button style="width: 70px;" onclick="quickSearch();">Search</button>
                    </div>
               
                    <div class="horizontal-line" style="position: relative;top:-12px"></div>                    
                    <!-- Detailed Search Form -->
                    <div class="search-form">
                        <div class="input-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" name="name" placeholder="[enter name]" title="Site Name or any alternative names" onfocus="this.select()" />
                        </div>
                        <div class="input-group">
                            <label for="text">Text Fields:</label>
                            <input type="text" id="text" name="text" placeholder="[enter text]" title="Any text that appears in History, StartDate, EndDate, AccessDetails, Description or Conservation Notes" onfocus="this.select()" />
                        </div>


                        <div class="input-group">
                            <label for="area">Area:</label>
                            <select id="area" name="area" title="Buddlepit Forum mining area">
                                <option value="">[select area]</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="os-sheet">OS Sheet:</label>
                            <select id="os-sheet" name="os-sheet">
                                <option value="">[select OS Sheet]</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="site-type">Site Type:</label>
                            <select id="site-type" name="site-type">
                                <option value="">[select site type]</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="product">Products:</label>
                            <select id="product" name="product">
                                <option value="">[select product]</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="gridref">or Grid Ref:</label>
                            <input type="text" id="gridref" name="distance" onblur="validateGridRef(this);" pattern="^([STNHOstnho][A-Za-z]\s?)(\d{5}\s?\d{5}|\d{4}\s?\d{4}|\d{3}\s?\d{3}|\d{2}\s?\d{2}|\d{1}\s?\d{1})$" placeholder="[SS EEEE NNNN]" title="Enter Grid Ref - then search radius" onfocus="this.select()" />
                        </div>    
                        <div class="input-group">
                            <label for="latlong">Lat Long:</label>
                            <input type="text" id="latlong" name="latlong" onblur="validateLatLong(this);" pattern="^-?([0-9]|[1-8][0-9]|90)(\.\d+)?\s*,\s*-?((0|[1-9]|[1-9][0-9]|1[0-7][0-9]|180)(\.\d+)?)$" placeholder="[Lat, Lon]" title="Enter Lat, Lon - then search radius" onfocus="this.select()"/>
                        </div>                      

                    
                        <div class="input-group" style="position: relative; left:4px;">
                            <label for="distance">Within km:</label>
                            <input type="number" min="0" max="50" id="distance" name="distance" placeholder="[enter distance in km]" onblur="updateMinMax(this)" title="Enter [Lat, Lon] or Grid Ref - then search radius" onfocus="this.select()"  />
                        </div>
                        <div class="input-group">
                            <label for="is-crow">Is Crow:</label>
                            <input type="checkbox" id="is-crow" name="is-crow"  onclick="return toggleCheckbox();">
                        </div>                          
                        <div class="button-group">
                            <button type="submit" style="width: 70px;" onclick="search();">Search</button>
                            <button type="reset" style="width: 70px;" onclick="reset();">Reset</button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <div class="searchresults">
            
            <table id="data-table" style="display: none; text-align:left" >
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th title="Does not imply right of access">Crow</th>
                        <th title="Corresponds to Buddlepit Forum Areas" style="width:85px">Area Name</th>
                        <th>Products</th>
                        <th>Lat, Lon</th>
                        <th style="width:85px">Grid Ref</th>
                        <th title="Distance from specified Lat,Lon or GridRef">Distance</th>
                        <th style="width:85px">Site Type</th>
                        <th style="width:400px" title="Text from History, Access Details, Description and Conservation Notes">Text Fields</th>

                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically added here -->
                </tbody>
            </table>
            <div id="search-summary" style="display: none; text-align: center;padding: 7px;">No Matching Records</div>
        </div>


        <script>
            const MAX_RESULTS = 500;
            initiallise();


            function reset() {
                document.getElementById("name").value = "";
                document.getElementById("text").value = "";
                document.getElementById("area").value = "";
                document.getElementById("os-sheet").value = "";
                document.getElementById("site-type").value = "";
                document.getElementById("product").value = "";
                document.getElementById("latlong").value = "";
                document.getElementById("latlong").style.background = 'white';
                document.getElementById("gridref").value = "";
                document.getElementById("gridref").style.background = 'white';
                document.getElementById("distance").value = "";
                document.getElementById("is-crow").indeterminate = true;
                state = 2; // Initial state: indeterminate
                document.getElementById("name").focus();
            }


            function search() {
                // Validate form
                if(!validate())
                    return;

                var name = document.getElementById("name").value.trim() == "" ? null : document.getElementById("name").value.trim();
                var text = document.getElementById("text").value.trim() == "" ? null : document.getElementById("text").value.trim();
                var areaID = document.getElementById("area").value.trim() == "" ? null : parseInt(document.getElementById("area").value.trim());
                var sheet = document.getElementById("os-sheet").value.trim() == "" ? null : document.getElementById("os-sheet").value.trim();
                var siteTypeID = document.getElementById("site-type").value.trim() == "" ? null : parseInt(document.getElementById("site-type").value.trim());
                var productID = document.getElementById("product").value.trim() == "" ? null : parseInt(document.getElementById("product").value.trim());
                var lat = null, lon = null;
                if(document.getElementById("latlong").value.trim().length > 0) {
                    lat = parseFloat(document.getElementById("latlong").value.trim().split(",")[0]);
                    lon = parseFloat(document.getElementById("latlong").value.trim().split(",")[1]);
                }
                var distance = document.getElementById("distance").value.trim() == "" ? null : parseFloat(document.getElementById("distance").value.trim());
                var isCrow = document.getElementById("is-crow").indeterminate ? null :(document.getElementById("is-crow").checked ? true : false);
            

                startTime = performance.now();
                spinner.style.display = "block";

                var qs =`id=null&name=${name}&text_fields=${text}&area_id=${areaID}&sheet=${sheet}&is_crow=${isCrow}&site_type_id=${siteTypeID}&product_Ids=${productID}&lat=${lat}&lon=${lon}&distance=${distance}`;

                //Connsole.log(qs)

                fetch("https://www.buddlepit.co.uk/api/search.php?" + qs)
                    .then(response => response.json())
                    .then(data => {
                        showResults(data, 'detail');
                        spinner.style.display = "none";
                    })
                    .catch(error => console.error('Error fetching data:', error)
                );
                

            }

            function validate() {
                var nameNotSet = document.getElementById("name").value.trim() == "";
                var textFieldsNotSet = document.getElementById("text").value.trim() == "";
                var areaNotSelected = document.getElementById("area").value.trim() == "";
                var osSheetNotSelected = document.getElementById("os-sheet").value.trim() == "";
                var siteTypeNotSelected = document.getElementById("site-type").value.trim() == "";
                var productNotSelected = document.getElementById("product").value.trim() == "";
                var latLonNotSelected=  document.getElementById("latlong").value.trim() == "";
                var distanceNotSelected = document.getElementById("distance").value.trim() == "";
                var spinner = document.getElementById("spinner");



                // If latlon or distance set, they must be valid
                if(!latLonNotSelected) {
                    if(!document.getElementById("latlong").checkValidity()) {
                        alert("Invalid Lat, Lon");
                        document.getElementById("latlong").focus();
                        return false;
                    }
                }
                if(!distanceNotSelected) {
                    if(!document.getElementById("distance").checkValidity()) {
                        alert("Invalid distance");
                        document.getElementById("distance").focus();
                        return false;
                    }
                }
                if(!latLonNotSelected && distanceNotSelected) {
                    alert("If LatLon/GridRef is set, distance must be set");
                    document.getElementById("distance").focus();
                    return false;
                }

                if(latLonNotSelected && !distanceNotSelected) {
                    alert("If distance is set, LatLon/GridRef must be set");
                    document.getElementById("latlong").focus();
                    return false;
                }

                // Something must have been selected
                if(nameNotSet && textFieldsNotSet && areaNotSelected && osSheetNotSelected && siteTypeNotSelected && productNotSelected && latLonNotSelected && distanceNotSelected) {
                    alert("Please enter at least one search criteria");
                    document.getElementById("name").focus();
                    return false;
                }

                return true;
            }


            var startTime;
            var lastLetterSelected = "";
            function letterSearch(letter) {
                lastLetterSelected = letter;
                startTime = performance.now();
                spinner.style.display = "block";
                fetch('https://www.buddlepit.co.uk/api/letterSearch.php?letter=' + letter)
                    .then(response => response.json())
                    .then(data => {
                        showResults(data, "letter");
                        spinner.style.display = "none";
                    })
                    .catch(error => console.error('Error fetching data:', error)
                );

            }


            function quickSearch() {
                var quicksearch = document.getElementById("quick-search");
        
                if (quicksearch.value.trim().length <1) {
                    alert("Please enter a quick search term.)");
                    quicksearch.focus();
                    return;
                }

                startTime = performance.now();
                spinner.style.display = "block";
                fetch('https://www.buddlepit.co.uk/api/quickSearch.php?search=' + quicksearch.value)
                    .then(response => response.json())
                    .then(data => {
                        showResults(data, "quick");
                        spinner.style.display = "none";
                    })
                    .catch(error => console.error('Error fetching data:', error)
                );
                
                quicksearch.focus();
                quicksearch.select();
            }
        
            function showResults(data, searchType) {
                //                     letter, detail, quick

                const tableBody = document.querySelector('#data-table tbody');
                tableBody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.ID}</td>
                        <td>${highlightSiteName(item.Names,searchType)}</td>
                        <td>${highlightLocation(item.Location, searchType)}</td>
                        <td style='text-align: center'>${item.IsCrow?"Y":"N"}</td>
                        <td>${item.AreaName}</td>
                        <td>${highlightWithSpaces(item.Products, searchType)}</td>
                        <td>${isNaN(item.Lat) ? "" : parseFloat(item.Lat).toFixed(5)},${isNaN(item.Lat) ? "" : parseFloat(item.Long).toFixed(5)}</td>
                        <td>${item.GridRef}</td>
                        <td>${item.Distance ==null ? "-" : item.Distance.toFixed(1) + "km"}</td>
                        <td>${item.SiteType??"-"}</td>
                        <td title="${item.Summary.replace(/<[^>]*>/g, '')}">${highlightWithSpaces(truncateWithEllipsis(item.Summary, 300), searchType)}</td>
        
                    `;
                    tableBody.appendChild(row);
                });
                


                var elapsed = performance.now() - startTime;
                if(data.length == 0) {
                    document.getElementById("data-table").style.display = "none";
                    document.getElementById("search-summary").style.display = "block";
                    document.getElementById("search-summary").innerText = `No matching records found in ${elapsed.toFixed(0)}ms.`;
                    // Letter search not capped for now
                } else if (data.length >= MAX_RESULTS && searchType != "letter") {
                    document.getElementById("data-table").style.display = "block";
                    document.getElementById("search-summary").style.display = "block";
                    document.getElementById("search-summary").innerText = `Maximum of ${MAX_RESULTS} records returned in ${elapsed.toFixed(0)}mS. Please refine your search.`;
                } else {
                    document.getElementById("data-table").style.display = "block";
                    document.getElementById("search-summary").style.display = "block";
                    document.getElementById("search-summary").innerText = `${data.length} matching records found in ${elapsed.toFixed(0)}ms.`;
                }

            }




            function highlightSiteName(text, searchType) {
                //                           detail, letter, quick
                if(text == null)
                    return text;


                var search = document.getElementById("quick-search").value;
                if(searchType == "quick") {
                    const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
                    // Create a regular expression pattern with spaces optional
                    const pattern = escapedSearch.split(' ').join('\\s*');
    
                    // Create a regular expression object with global and case-insensitive flags
                    const regex = new RegExp(pattern, 'gi');
    
                    // Replace matches with brackets
                    const highlightedText = text.replace(regex, '<span style="background-color:black;color: yellow;">$&</span>');
                    return highlightedText;
                } else if (searchType == "letter") {
                    let regexPattern = new RegExp(`(?:^|(?<=,\\s))(${lastLetterSelected})`, "ig");
                    return text.replace(regexPattern, '<span style="background-color:black;color: yellow;">$&</span>');
                } else 
                    return text;

            }


            function highlightLocation(text, searchType) {
                //                           detail, letter, quick

                if(text == null)
                    return text;


                var search = document.getElementById("quick-search").value;
                if(searchType == "quick") {
                    const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
                    // Create a regular expression pattern with spaces optional
                    const pattern = escapedSearch.split(' ').join('\\s*');
    
                    // Create a regular expression object with global and case-insensitive flags
                    const regex = new RegExp(pattern, 'gi');
    
                    // Replace matches with brackets
                    const highlightedText = text.replace(regex, '<span style="background-color:black;color: yellow;">$&</span>');
                    return highlightedText;
                } else
                    return text;

            }

            function highlightWithSpaces(text, searchType) {
                //                           detail, letter, quick

                if(text == null)
                    return text;


                if(searchType == "quick") {
                    let regexPattern = new RegExp(document.getElementById("quick-search").value, "gi");
                    let highlightedHtml = text.replace(regexPattern, (match) => {
                        return `<span style="background-color:black;color: yellow;">${match}</span>`;
                    });
                    return highlightedHtml;
                } else
                    return text;
            }



            ckIsCrow = document.getElementById('is-crow');
            let state = 2; // Initial state: indeterminate
            ckIsCrow.indeterminate=true;
            ckIsCrow.title = "No preference";
            function toggleCheckbox() {
                
                state = (state + 1) % 3; // Cycle through states: 0, 1, 2

                switch (state) {
                    case 0:
                        ckIsCrow.checked = false;
                        ckIsCrow.indeterminate = false;
                        ckIsCrow.title = "Not Crow land";
                        break;
                    case 1:
                        ckIsCrow.checked = true;
                        ckIsCrow.indeterminate = false;
                        ckIsCrow.title = "Is Crow land";
                        break;
                    case 2:
                        ckIsCrow.checked = false;
                        ckIsCrow.indeterminate = true;
                        ckIsCrow.title = "No preference";
                        break;
                }
            }

            function truncateWithEllipsis(str, maxLength) {
            if (str.length > maxLength) {
                return str.substring(0, maxLength - 3) + '...';
            }
            return str;
        }


        // Set initial focus and populate dropdowns
        function initiallise() {
            document.getElementById("quick-search").focus();

            populateDropdown("area", "https://www.buddlepit.co.uk/api/getAreaList.php", "Name");
            populateDropdown("os-sheet", "https://www.buddlepit.co.uk/api/getSheetList.php", "Sheet");    
            populateDropdown("site-type", "https://www.buddlepit.co.uk/api/getSiteTypeList.php", "Description");
            populateDropdown("product", "https://www.buddlepit.co.uk/api/getProductList.php", "Name");
        }

        function populateDropdown(dropdownId, url, bindToProperty) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const dropdown = document.getElementById(dropdownId);
                    data.forEach(item => {
                        const option = document.createElement('option');
                        if(dropdownId == "os-sheet")
                            option.value = item.Sheet;
                        else
                            option.value = item.ID;
                        option.innerText = item[bindToProperty];
                        dropdown.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching data:', error)
            );}

        // Ensure that the min and max attributes of the number input are set correctly
        function updateMinMax(input) {
            if (input.value === '') {
                return
            }

            var value = parseInt(input.value);
           

            // Check if the value is less than the minimum
            if (value < parseInt(input.min)) {
                input.value = input.min;
            }

            // Check if the value is greater than the maximum
            if (value > parseFloat(input.max)) {
                input.value = input.max;
            }

            input.value = value.toFixed(1);
        }

        function validateGridRef(gridRef) {
            gridRef.value = gridRef.value.toUpperCase().trim().replace(/\s+/g, "");

            if(gridRef.value == "") {
                document.getElementById("latlong").value = "";
                return;
            }


            if (!gridRef.checkValidity() && gridRef.value !== '') {
                gridRef.style.background = 'red';
            } else {
                gridRef.style.background = 'white';
            }

            if(gridRef.checkValidity()) {
                // Format as SS EEEE WWWW 
                var g = gridRef.value;
                let firstGroupLength = 2;
                let secondGroupLength = Math.ceil((g.length - firstGroupLength) / 2);
                gridRef.value  = g.slice(0, firstGroupLength) + " " +
                    g.slice(firstGroupLength, firstGroupLength + secondGroupLength) + " " +
                    g.slice(firstGroupLength + secondGroupLength);


                // Set latlon
                osgb=new GT_OSGB();
                if(osgb.parseGridRef(gridRef.value)) {
                    wgs84=osgb.getWGS84();
                        document.getElementById("latlong").value = wgs84.latitude.toFixed(4) + ", " + wgs84.longitude.toFixed(4);
                }
            } 
        }


        function validateLatLong(latLon) {
            if(latLon.value == "") {
                document.getElementById("gridref").value = "";
                return;
            }




            if (!latLon.checkValidity() && latLon.value !== '') {
                latLon.style.background = 'red';
                document.getElementById("latlong").value = "";
                document.getElementById("gridref").value = "";
            } else {
                latLon.style.background = 'white';
            }

            if(latLon.checkValidity()) {
                // Set latlon
                latLon.value = latLon.value.toUpperCase().trim().replace(/\s+/g, "");
                var arr = latLon.value.split(",");
                var lat = parseFloat(arr[0]);
                var lon = parseFloat(arr[1]);

                
                latLon.value = lat.toFixed(4) + ", " + lon.toFixed(4);
                wgs84 = new GT_WGS84();

                wgs84.setDegrees(lat, lon);
                osgb=wgs84.getOSGB();
                    
                document.getElementById("gridref").value = osgb.getGridRef(4);
            }
        }

        </script>
        

    </body>
</html>     